<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scent Finder: AI가 찾아주는 당신만의 인생 향수</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- PWA basics -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#c9a96a">
  <link rel="icon" href="/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/icon-192.png">

    <style>
    :root {
      --cream: #f7f2e9;
      --linen: #efe6d8;
      --gold: #c9a96a;
      --deep-brown: #53483f;
      --sage: #8b9582;
      --lavender: #a398c5;
      --soft-shadow: 0 18px 35px rgba(83, 72, 63, 0.12);
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: var(--cream);
      color: var(--deep-brown);
    }

    .font-serif {
      font-family: 'Playfair Display', serif;
      color: var(--deep-brown);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.8s ease-out forwards;
    }

    .hero-section,
    .quiz-section {
      position: relative;
      border-radius: 28px;
      padding: clamp(1.5rem, 4vw, 3rem);
      background: linear-gradient(140deg, rgba(239, 230, 216, 0.7), rgba(247, 242, 233, 0.95));
      overflow: hidden;
    }

    .hero-section::before,
    .quiz-section::before {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.35);
      pointer-events: none;
    }

    .hero-section .card,
    .quiz-section .card {
      position: relative;
    }

    .card {
      position: relative;
      background: rgba(255, 255, 255, 0.88);
      border-radius: 24px;
      border: 1px solid rgba(83, 72, 63, 0.12);
      box-shadow: var(--soft-shadow);
      backdrop-filter: blur(6px);
    }

    .hero-card {
      background: linear-gradient(115deg, rgba(255, 255, 255, 0.92) 0%, rgba(247, 242, 233, 0.85) 40%, rgba(247, 242, 233, 0.5) 100%);
      background-image: url('/assets/perfume-hero.png');
      background-size: cover;
      background-position: center right;
      background-repeat: no-repeat;
      color: var(--deep-brown);
    }

    .hero-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(115deg, rgba(255, 255, 255, 0.92) 0%, rgba(247, 242, 233, 0.85) 40%, rgba(247, 242, 233, 0.5) 100%);
      
    }

    .hero-card > * {
      position: relative;
      z-index: 1;
    }

    .badge-gold {
      display: inline-block;
      padding: 0.35rem 1.1rem;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      border-radius: 9999px;
      background: rgba(201, 169, 106, 0.18);
      color: var(--deep-brown);
      font-weight: 600;
    }

    .text-accent {
      color: var(--gold);
    }

    .text-muted {
      color: rgba(83, 72, 63, 0.72);
    }

    .text-soft {
      color: rgba(83, 72, 63, 0.56);
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.8rem 2.5rem;
      border-radius: 9999px;
      background: linear-gradient(135deg, var(--gold), #d9b784);
      color: #fff;
      font-weight: 700;
      letter-spacing: 0.02em;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      box-shadow: 0 10px 24px rgba(201, 169, 106, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(201, 169, 106, 0.38);
    }

    .btn-primary:disabled {
      background: linear-gradient(135deg, #e0c99b, #d6c19d);
      opacity: 0.65;
      box-shadow: none;
      cursor: not-allowed;
    }

    .btn-secondary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 2.25rem;
      border-radius: 9999px;
      border: 1px solid rgba(83, 72, 63, 0.18);
      background: rgba(255, 255, 255, 0.86);
      color: var(--deep-brown);
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    }

    .btn-secondary:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: var(--soft-shadow);
    }

    .btn-outline {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.65rem 1.75rem;
      border-radius: 9999px;
      border: 1px solid rgba(201, 169, 106, 0.6);
      background: rgba(247, 242, 233, 0.65);
      color: var(--deep-brown);
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    }

    .btn-outline:hover {
      transform: translateY(-1px);
      background: rgba(201, 169, 106, 0.16);
      box-shadow: var(--soft-shadow);
    }

    .option-card {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(83, 72, 63, 0.1);
      border-radius: 18px;
      padding: 1.25rem;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
    }

    .option-card.compact {
      padding: 0.9rem;
      font-size: 0.9rem;
      border-radius: 14px;
    }

    .option-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--soft-shadow);
      border-color: rgba(201, 169, 106, 0.55);
    }

    .option-card.selected {
      border-color: var(--gold);
      background-color: rgba(249, 240, 223, 0.95);
      box-shadow: 0 12px 28px rgba(201, 169, 106, 0.28);
      color: var(--deep-brown);
    }

    .progress-track {
      background-color: rgba(83, 72, 63, 0.12);
    }

    .progress-bar {
      background: linear-gradient(135deg, var(--gold), #d9b784);
    }

    .loader {
      border: 4px solid rgba(255, 255, 255, 0.6);
      border-top: 4px solid var(--gold);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .recommendation-card {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(83, 72, 63, 0.12);
      border-radius: 22px;
      padding: 1.5rem;
      box-shadow: var(--soft-shadow);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 0.35rem 0.9rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 9999px;
      background: rgba(201, 169, 106, 0.18);
      color: var(--deep-brown);
    }

    .keyword-chip {
      padding: 0.35rem 0.7rem;
      font-size: 0.75rem;
      border-radius: 12px;
      background: rgba(139, 149, 130, 0.16);
      color: var(--deep-brown);
      font-weight: 500;
    }

    .price-text {
      color: var(--deep-brown);
    }

    .subtle-text {
      color: rgba(83, 72, 63, 0.6);
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div id="app" class="max-w-2xl mx-auto p-4 md:p-8">
    <!-- Start Screen -->
    <section id="start-screen" class="text-center fade-in hero-section">
      <div class="card hero-card p-8 md:p-10 text-center max-w-xl mx-auto">
        <h1 class="text-4xl md:text-5xl font-serif font-bold mb-4">Scent Finder</h1>
        <p class="text-lg text-muted mb-6 leading-relaxed">당신의 기억과 감성을 담아<br>인생 향수를 찾아드릴게요.</p>
        <p class="text-soft mb-8">AI가 당신의 취향을 분석해드려요.</p>
        <button id="start-btn" class="btn-primary">맞춤 향수 찾기 시작</button>
      </div>
    </section>

    <!-- Quiz Screen -->
    <section id="quiz-screen" class="hidden quiz-section">
      <div class="card p-6 md:p-8">
        <div class="mb-6">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-semibold text-accent tracking-wide uppercase">Question <span id="question-number"></span>/18</span>
            <span id="question-type" class="text-xs text-soft tracking-wide uppercase"></span>
          </div>
          <div class="progress-track w-full rounded-full h-2.5">
            <div id="progress-bar" class="progress-bar h-2.5 rounded-full transition-all duration-300"></div>
          </div>
        </div>
        <h2 id="question-title" class="text-2xl md:text-3xl font-bold mb-6 leading-snug"></h2>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        <div id="button-container" class="mt-8 flex flex-col sm:flex-row gap-4 justify-between items-center">
          <button id="prev-button" class="btn-secondary hidden">이전</button>
          <button id="next-button" class="btn-primary w-full sm:w-auto">다음</button>
        </div>
      </div>
    </section>

    <!-- Loading Screen -->
    <section id="loading-screen" class="hidden text-center fade-in">
      <div class="card p-8 flex flex-col items-center justify-center min-h-[400px]">
        <div id="loader" class="loader mb-6"></div>
        <h2 id="loading-title" class="text-2xl font-bold mb-2">AI가 분석 중입니다.</h2>
        <p id="loading-message" class="text-soft leading-relaxed">당신의 감성과 기억에서<br>가장 빛나는 향기를 찾는 중...</p>
        <div id="retry-container" class="hidden mt-6">
          <button id="retry-btn" class="btn-outline">다시 요청</button>
        </div>
      </div>
    </section>

    <!-- Results Screen -->
    <section id="results-screen" class="hidden fade-in">
      <div class="card p-6 md:p-8">
        <div class="text-center mb-6">
          <p class="badge-gold">당신만의 향기 페르소나</p>
          <h3 id="persona-title" class="text-2xl md:text-3xl font-bold"></h3>
          <p id="persona-description" class="text-soft mt-2 leading-relaxed"></p>
        </div>
        <div id="recommendations-container" class="space-y-4"></div>
        <div class="mt-8 text-center">
          <button id="restart-btn" class="btn-secondary">다시 찾기</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ----- Elements
    const startBtn = document.getElementById('start-btn');
    const retryBtn = document.getElementById('retry-btn');
    const restartBtn = document.getElementById('restart-btn');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const loadingScreen = document.getElementById('loading-screen');
    const resultsScreen = document.getElementById('results-screen');
    const questionNumberEl = document.getElementById('question-number');
    const questionTypeEl = document.getElementById('question-type');
    const progressBarEl = document.getElementById('progress-bar');
    const questionTitleEl = document.getElementById('question-title');
    const optionsContainer = document.getElementById('options-container');
    const nextButton = document.getElementById('next-button');
    const prevButton = document.getElementById('prev-button');
    const loader = document.getElementById('loader');
    const retryContainer = document.getElementById('retry-container');
    const loadingTitle = document.getElementById('loading-title');
    const loadingMessage = document.getElementById('loading-message');

    startBtn.addEventListener('click', startQuiz);
    nextButton.addEventListener('click', nextQuestion);
    prevButton.addEventListener('click', prevQuestion);
    retryBtn.addEventListener('click', showLoadingAndAnalyze);
    restartBtn.addEventListener('click', restartQuiz);

    // ----- Quiz Data
    const quizData = [
      { question: "어떤 타입의 향수를 찾고 계신가요?", type: 'single', options: ["남성향수", "여성향수", "젠더뉴트럴 향수", "상관없음 (모든 타입)"] },
      { question: "이 향수를 주로 언제, 어디서 사용하고 싶으신가요?", type: 'single', options: ["매일 편안하게 (데일리)", "중요한 미팅·발표 (프로페셔널)", "설레는 데이트·소개팅 (로맨틱)", "친구들과의 즐거운 모임 (소셜)", "혼자만의 휴식 시간 (릴랙스)"] },
      { question: "어떤 향 계열에 마음이 끌리시나요?", type: 'multiple', options: ["다채로운 꽃의 향연(플로럴)", "달콤 생기 있는 과즙(프루티)", "상큼 청량한 시트러스", "차분한 숲과 나무(우디)", "따뜻하고 이국적인 느낌(스파이시·오리엔탈)", "포근한 비누·살결 느낌(머스크·파우더리)"] },
      { question: "향수를 통해 표현하고 싶은 이미지는?", type: 'multiple', options: ["세련되고 도시적인", "따뜻하고 부드러운", "관능적이고 매혹적인", "지적이고 신뢰감 있는", "순수하고 깨끗한", "개성 있고 유니크한"] },
      { question: "평소 즐겨 입는 패션 스타일은?", type: 'multiple', options: ["미니멀·클래식", "캐주얼·스포티", "모던·시크", "페미닌·로맨틱", "유니크·빈티지"] },
      { question: "가장 좋아하는 하루의 시간대는 언제인가요?", type: 'single', options: ["이슬 맺힌 고요한 새벽", "햇살 쏟아지는 나른한 오후", "붉은 노을의 해질녘", "별이 빛나는 차분한 밤"] },
      { question: "마음이 편안해지는 장소를 고르세요.", type: 'multiple', options: ["비 온 뒤의 촉촉한 숲속", "파도 소리가 들리는 한적한 해변", "오래된 책 냄새가 나는 서재", "향기로운 꽃이 가득한 정원", "갓 구운 빵 냄새가 나는 골목"] },
      { question: "선호하는 원단의 감촉은 어떤가요?", type: 'single', options: ["부드럽게 감싸는 캐시미어", "시원하고 쾌적한 린넨", "매끄럽게 흐르는 실크", "깨끗하고 빳빳한 코튼"] },
      { question: "촉감으로 비유하면 어떤 쪽이 더 끌리나요?", type: 'single', options: ["보송한 파우더", "맑고 투명한 물기", "부드럽고 크리미함", "건조한 나무결", "서늘한 유리감"] },
      { question: "향의 존재감은 어느 정도가 좋나요?", type: 'single', options: ["내게만 은은하게", "대화 거리에서 느껴짐", "스치면 분명히 전해짐", "공간을 채우는 편"] },
      { question: "원하는 잔향 길이는?", type: 'single', options: ["2–4시간", "6–8시간", "10시간 이상", "의류에도 오래 남아도 좋음"] },
      { question: "향에 대한 민감도는?", type: 'single', options: ["쉽게 두통·피로를 느낌", "가끔 민감", "거의 괜찮음"] },
      { question: "향수를 선택할 때 더 중요한 것은?", type: 'single', options: ["많은 사람이 좋아하는 '베스트셀러'", "나만 알고 싶은 '니치 향수'"] },
      { question: "피하고 싶은 향의 느낌이 있다면?", type: 'single', options: ["너무 달아 울렁거리는 향", "인공적으로 머리 아픈 향", "톡 쏘듯 자극적인 향", "스모키·가죽 느낌의 향", "특별히 없음"] },
      { question: "당신의 인생 향을 떠오르는 장면이나 단어로 자유롭게 적어주세요.", type: 'text', placeholder: "예: 비 갠 뒤 골목, 막 다린 셔츠, 차가운 유리창, 오후의 햇살" },
      { question: "특별히 선호하는 향수 하우스가 있나요? (선택사항)", type: 'multiple_optional', options: ["샤넬 (CHANEL)", "디올 (DIOR)", "톰 포드 (TOM FORD)", "조 말론 (JO MALONE)", "크리드 (CREED)", "메종 마르지엘라 (MAISON MARGIELA)", "펜할리곤스 (PENHALIGON'S)", "르 라보 (LE LABO)", "바이레도 (BYREDO)", "랑방 (LANVIN)", "겔랑 (GUERLAIN)", "에르메스 (HERMÈS)", "프레데릭 말 (FRÉDÉRIC MALLE)", "라르티잔 파퓨뫼르 (L'ARTISAN PARFUMEUR)", "니시아네 (NISHANE)"], hasTextInput: true, textPlaceholder: "다른 선호 브랜드가 있다면 적어주세요" },
      { question: "배제하고 싶은 향수 하우스가 있나요? (선택사항)", type: 'multiple_optional', options: ["샤넬 (CHANEL)", "디올 (DIOR)", "톰 포드 (TOM FORD)", "조 말론 (JO MALONE)", "크리드 (CREED)", "메종 마르지엘라 (MAISON MARGIELA)", "펜할리곤스 (PENHALIGON'S)", "르 라보 (LE LABO)", "바이레도 (BYREDO)", "랑방 (LANVIN)", "겔랑 (GUERLAIN)", "에르메스 (HERMÈS)", "프레데릭 말 (FRÉDÉRIC MALLE)", "라르티잔 파퓨뫼르 (L'ARTISAN PARFUMEUR)", "니시아네 (NISHANE)"], hasTextInput: true, textPlaceholder: "다른 배제하고 싶은 브랜드가 있다면 적어주세요" }
    ];

    // ----- State
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let selectedOptions = new Set();
    let isProcessing = false;

    function startQuiz() {
      startScreen.classList.add('hidden');
      quizScreen.classList.remove('hidden');
      currentQuestionIndex = 0;
      userAnswers = [];
      isProcessing = false;
      displayQuestion();
    }

        function displayQuestion() {
      selectedOptions.clear();
      const question = quizData[currentQuestionIndex];
      const isLast = currentQuestionIndex === quizData.length - 1;
      const isFirst = currentQuestionIndex === 0;
      questionNumberEl.textContent = currentQuestionIndex + 1;
      progressBarEl.style.width = `${((currentQuestionIndex + 1) / quizData.length) * 100}%`;
      questionTitleEl.textContent = question.question;
      optionsContainer.innerHTML = '';
      nextButton.textContent = isLast ? '결과 보기' : '다음';

      // 이전 버튼 표시/숨김
      if (isFirst) {
        prevButton.classList.add('hidden');
      } else {
        prevButton.classList.remove('hidden');
      }

      // 이전 답변이 있다면 복원
      const previousAnswer = userAnswers[currentQuestionIndex];
      let previousTextValue = '';
      if (previousAnswer && previousAnswer.answers) {
        // 텍스트 입력이 있는 경우, 마지막 항목이 텍스트 입력일 수 있음
        if (question.hasTextInput && previousAnswer.answers.length > 0) {
          const lastAnswer = previousAnswer.answers[previousAnswer.answers.length - 1];
          if (!question.options.includes(lastAnswer)) {
            previousTextValue = lastAnswer;
            previousAnswer.answers = previousAnswer.answers.slice(0, -1);
          }
        }
        // 선택된 옵션들 복원
        previousAnswer.answers.forEach(answer => {
          const index = question.options.indexOf(answer);
          if (index !== -1) {
            selectedOptions.add(index.toString());
          }
        });
      }

      if (question.type === 'text') {
        questionTypeEl.textContent = '주관식 (자유 입력)';
        document.getElementById('button-container').classList.remove('hidden');
        const textArea = document.createElement('textarea');
        textArea.id = 'text-answer';
        textArea.className = 'w-full h-32 p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-[rgba(201,169,106,0.45)] focus:border-[rgba(201,169,106,0.8)] transition';
        textArea.placeholder = question.placeholder;
        // 이전 답변 복원
        if (previousAnswer && previousAnswer.answers && previousAnswer.answers[0]) {
          textArea.value = previousAnswer.answers[0];
        }
        optionsContainer.appendChild(textArea);
        optionsContainer.classList.remove('md:grid-cols-2');
        nextButton.disabled = false;
      } else {
        const isOptional = question.type === 'multiple_optional';
        const isMultiple = question.type === 'multiple' || question.type === 'multiple_optional';
        questionTypeEl.textContent = isMultiple ? (isOptional ? '복수 선택 가능 (선택사항)' : '복수 선택 가능') : '단일 선택';
        document.getElementById('button-container').classList.remove('hidden');

        const isPerfumeHouseQuestion = question.options.length > 8;
        if (isPerfumeHouseQuestion) {
          optionsContainer.classList.add('md:grid-cols-3', 'lg:grid-cols-4');
        } else {
          optionsContainer.classList.add('md:grid-cols-2');
        }

        question.options.forEach((optionText, index) => {
          const card = document.createElement('div');
          const cardClass = isPerfumeHouseQuestion ? 'option-card compact text-left' : 'option-card text-left';
          card.className = cardClass;
          card.textContent = optionText;
          card.dataset.optionIndex = index;
          card.onclick = () => toggleOption(card, question.type);
          // 이전에 선택된 옵션이면 선택된 상태로 표시
          if (selectedOptions.has(index.toString())) {
            card.classList.add('selected');
          }
          optionsContainer.appendChild(card);
        });

        // 텍스트 입력 필드 추가
        if (question.hasTextInput) {
          const textInputContainer = document.createElement('div');
          textInputContainer.className = 'col-span-full mt-4';
          const textInput = document.createElement('input');
          textInput.type = 'text';
          textInput.id = 'additional-text-input';
          textInput.className = 'w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-[rgba(201,169,106,0.45)] focus:border-[rgba(201,169,106,0.8)] transition';
          textInput.placeholder = question.textPlaceholder;
          // 이전 텍스트 입력 값 복원
          if (previousTextValue) {
            textInput.value = previousTextValue;
          }
          textInputContainer.appendChild(textInput);
          optionsContainer.appendChild(textInputContainer);
        }

        updateNextButtonState();
      }
    }


    function toggleOption(card, type) {
      if (isProcessing) return;
      const optionIndex = card.dataset.optionIndex;
      if (type === 'single') {
        isProcessing = true;
        if (selectedOptions.has(optionIndex)) return;
        const currentSelected = optionsContainer.querySelector('.selected');
        if (currentSelected) currentSelected.classList.remove('selected');
        card.classList.add('selected');
        selectedOptions.clear();
        selectedOptions.add(optionIndex);
        setTimeout(() => { nextQuestion(); isProcessing = false; }, 300);
      } else {
        if (selectedOptions.has(optionIndex)) {
          selectedOptions.delete(optionIndex);
          card.classList.remove('selected');
        } else {
          selectedOptions.add(optionIndex);
          card.classList.add('selected');
        }
      }
      updateNextButtonState();
    }

    function updateNextButtonState() {
      const q = quizData[currentQuestionIndex];
      if (q.type === 'multiple') {
        nextButton.disabled = selectedOptions.size === 0;
      } else if (q.type === 'multiple_optional') {
        nextButton.disabled = false; // 선택사항이므로 항상 활성화
      }
    }

    function nextQuestion() {
      const question = quizData[currentQuestionIndex];
      if (question.type === 'text') {
        const textAnswer = (document.getElementById('text-answer').value || '').trim();
        userAnswers.push({ question: question.question, answers: [textAnswer] });
      } else {
        const selectedTexts = Array.from(selectedOptions).map(index => question.options[parseInt(index)]);
        const answers = [...selectedTexts];

        // 추가 텍스트 입력이 있는 경우 포함
        if (question.hasTextInput) {
          const additionalTextInput = document.getElementById('additional-text-input');
          const additionalText = (additionalTextInput?.value || '').trim();
          if (additionalText) {
            answers.push(additionalText);
          }
        }

        // 선택사항 질문은 답변이 없어도 저장
        if (question.type === 'multiple_optional' || answers.length > 0) {
          userAnswers.push({ question: question.question, answers: answers });
        }
      }
      currentQuestionIndex++;
      if (currentQuestionIndex < quizData.length) {
        displayQuestion();
      } else {
        showLoadingAndAnalyze();
      }
    }

    function prevQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        // 이전 답변 제거
        if (userAnswers.length > 0) {
          userAnswers.pop();
        }
        displayQuestion();
      }
    }

    async function showLoadingAndAnalyze() {
      quizScreen.classList.add('hidden');
      loadingScreen.classList.remove('hidden');
      loader.classList.remove('hidden');
      retryContainer.classList.add('hidden');
      loadingTitle.textContent = 'AI가 분석 중입니다.';
      loadingMessage.innerHTML = '당신의 감성과 기억에서<br>가장 빛나는 향기를 찾는 중...';
      try {
        const result = await callGeminiAPI(userAnswers);
        displayResults(result);
      } catch (error) {
        console.error('AI analysis error:', error);
        loader.classList.add('hidden');
        loadingTitle.textContent = '오류 발생';
        loadingMessage.innerHTML = '죄송합니다. 분석 중 오류가 발생했습니다.<br>다시 한 번 시도해주세요.';
        retryContainer.classList.remove('hidden');
      }
    }

    async function callGeminiAPI(answers) {
      const response = await fetch('/api/gemini', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ answers })
      });
      if (!response.ok) {
        const text = await response.text().catch(() => '');
        throw new Error(`API request failed: ${response.status} ${text}`);
      }
      return response.json();
    }

    function displayResults(result) {
      loadingScreen.classList.add('hidden');
      resultsScreen.classList.remove('hidden');
      document.getElementById('persona-title').textContent = result.persona.title;
      document.getElementById('persona-description').textContent = result.persona.description;
      const recommendationsContainer = document.getElementById('recommendations-container');
      recommendationsContainer.innerHTML = '';
      (result.recommendations || []).forEach((perfume, index) => {
        const encodedName = encodeURIComponent((perfume.name || '').replace(/ /g, '+'));
        const card = `
          <div class="recommendation-card fade-in" style="animation-delay: ${index * 0.2}s;">
            <div class="flex items-start sm:items-center gap-4">
            
              <div class="flex-grow">
                <div class="flex justify-between items-start gap-3">
                  <div>
                    <p class="text-sm text-accent font-semibold">${perfume.brand || ""}</p>
                    <h4 class="text-lg md:text-xl font-bold">${perfume.name || ''}</h4>
                  </div>
                  <span class="tag">추천 ${index + 1}</span>
                </div>
                <p class="text-soft mt-2 mb-3 leading-relaxed">${perfume.description || ''}</p>
                <div class="flex flex-wrap gap-2">
                  ${(perfume.keywords || []).map(kw => `<span class="keyword-chip">${kw}</span>`).join('')}
                </div>
              </div>
            </div>
            <div class="mt-5 pt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4" style="border-top: 1px solid rgba(83, 72, 63, 0.12);">
              <div>
                <p class="subtle-text">예상 가격</p>
                <p class="font-semibold price-text">${perfume.price || '가격 정보 없음'}</p>
              </div>
              <a href="${perfume.purchaseLink || '#'}" target="_blank" rel="noopener" class="btn-outline">구매 링크</a>
            </div>
          </div>`;
        recommendationsContainer.innerHTML += card;
      });
    }

    function restartQuiz() {
      resultsScreen.classList.add('hidden');
      startScreen.classList.remove('hidden');
      startScreen.classList.add('fade-in');
    }
  </script>
</body>
</html>






