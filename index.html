<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scent Finder: AI가 찾아주는 당신만의 인생 향수</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- PWA basics -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#c9a96a">
  <link rel="icon" href="/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/icon-192.png">

    <style>
    :root {
      --cream: #f7f2e9;
      --linen: #efe6d8;
      --gold: #c9a96a;
      --deep-brown: #53483f;
      --sage: #8b9582;
      --lavender: #a398c5;
      --soft-shadow: 0 18px 35px rgba(83, 72, 63, 0.12);
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: var(--cream);
      color: var(--deep-brown);
    }

    .font-serif {
      font-family: 'Playfair Display', serif;
      color: var(--deep-brown);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.8s ease-out forwards;
    }

    .hero-section,
    .quiz-section {
      position: relative;
      border-radius: 28px;
      padding: clamp(1.5rem, 4vw, 3rem);
      background: linear-gradient(140deg, rgba(239, 230, 216, 0.7), rgba(247, 242, 233, 0.95));
      overflow: hidden;
    }

    .hero-section::before,
    .quiz-section::before {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.35);
      pointer-events: none;
    }

    .hero-section .card,
    .quiz-section .card {
      position: relative;
    }

    .card {
      position: relative;
      background: rgba(255, 255, 255, 0.88);
      border-radius: 24px;
      border: 1px solid rgba(83, 72, 63, 0.12);
      box-shadow: var(--soft-shadow);
      backdrop-filter: blur(6px);
    }

    .hero-card {
      background: linear-gradient(115deg, rgba(255, 255, 255, 0.92) 0%, rgba(247, 242, 233, 0.85) 40%, rgba(247, 242, 233, 0.5) 100%);
      background-image: url('/assets/perfume-hero.png');
      background-size: cover;
      background-position: center right;
      background-repeat: no-repeat;
      color: var(--deep-brown);
    }

    .hero-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(115deg, rgba(255, 255, 255, 0.92) 0%, rgba(247, 242, 233, 0.85) 40%, rgba(247, 242, 233, 0.5) 100%);
      
    }

    .hero-card > * {
      position: relative;
      z-index: 1;
    }

    .notes-grid {
      display: grid;
      gap: 0.75rem;
      margin-bottom: 2rem;
    }

    @media (min-width: 640px) {
      .notes-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .note-card {
      background: rgba(247, 242, 233, 0.65);
      border: 1px solid rgba(83, 72, 63, 0.1);
      border-radius: 16px;
      padding: 1rem;
      text-align: left;
    }

    .note-card h4 {
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--deep-brown);
      margin-bottom: 0.4rem;
    }

    .note-card p {
      font-size: 0.95rem;
      color: var(--deep-brown);
      line-height: 1.4;
    }

    .badge-gold {
      display: inline-block;
      padding: 0.35rem 1.1rem;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      border-radius: 9999px;
      background: rgba(201, 169, 106, 0.18);
      color: var(--deep-brown);
      font-weight: 600;
    }

    .text-accent {
      color: var(--gold);
    }

    .text-muted {
      color: rgba(83, 72, 63, 0.72);
    }

    .text-soft {
      color: rgba(83, 72, 63, 0.56);
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.8rem 2.5rem;
      border-radius: 9999px;
      background: linear-gradient(135deg, var(--gold), #d9b784);
      color: #fff;
      font-weight: 700;
      letter-spacing: 0.02em;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      box-shadow: 0 10px 24px rgba(201, 169, 106, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(201, 169, 106, 0.38);
    }

    .btn-primary:disabled {
      background: linear-gradient(135deg, #e0c99b, #d6c19d);
      opacity: 0.65;
      box-shadow: none;
      cursor: not-allowed;
    }

    .btn-secondary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 2.25rem;
      border-radius: 9999px;
      border: 1px solid rgba(83, 72, 63, 0.18);
      background: rgba(255, 255, 255, 0.86);
      color: var(--deep-brown);
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    }

    .btn-secondary:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: var(--soft-shadow);
    }

    .btn-outline {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.65rem 1.75rem;
      border-radius: 9999px;
      border: 1px solid rgba(201, 169, 106, 0.6);
      background: rgba(247, 242, 233, 0.65);
      color: var(--deep-brown);
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    }

    .btn-outline:hover {
      transform: translateY(-1px);
      background: rgba(201, 169, 106, 0.16);
      box-shadow: var(--soft-shadow);
    }

    .option-card {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(83, 72, 63, 0.1);
      border-radius: 18px;
      padding: 1rem;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
    }

    .option-card.compact {
      padding: 0.75rem;
      font-size: 0.9rem;
      border-radius: 14px;
    }

    .option-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--soft-shadow);
      border-color: rgba(201, 169, 106, 0.55);
    }

    .option-card.selected {
      border-color: var(--gold);
      background-color: rgba(249, 240, 223, 0.95);
      box-shadow: 0 12px 28px rgba(201, 169, 106, 0.28);
      color: var(--deep-brown);
    }

    .progress-track {
      background-color: rgba(83, 72, 63, 0.12);
    }

    .progress-bar {
      background: linear-gradient(135deg, var(--gold), #d9b784);
    }

    .loader {
      border: 4px solid rgba(255, 255, 255, 0.6);
      border-top: 4px solid var(--gold);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .recommendation-card {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(83, 72, 63, 0.12);
      border-radius: 22px;
      padding: 1.5rem;
      box-shadow: var(--soft-shadow);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 0.35rem 0.9rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 9999px;
      background: rgba(201, 169, 106, 0.18);
      color: var(--deep-brown);
    }

    .keyword-chip {
      padding: 0.35rem 0.7rem;
      font-size: 0.75rem;
      border-radius: 12px;
      background: rgba(139, 149, 130, 0.16);
      color: var(--deep-brown);
      font-weight: 500;
    }

    .price-text {
      color: var(--deep-brown);
    }

    .subtle-text {
      color: rgba(83, 72, 63, 0.6);
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div id="app" class="max-w-2xl mx-auto p-4 md:p-8">
    <!-- Start Screen -->
    <section id="start-screen" class="text-center fade-in hero-section">
      <div class="card hero-card p-8 md:p-10 text-center max-w-xl mx-auto">
        <h1 class="text-4xl md:text-5xl font-serif font-bold mb-4">Scent Finder</h1>
        <p class="text-lg text-muted mb-6 leading-relaxed">당신의 기억과 감성을 담아<br>인생 향수를 찾아드릴게요.</p>
        <p class="text-soft mb-8">AI가 15가지 질문으로 취향을 분석하거나, 나만의 향수를 직접 조향해보세요.</p>
        <div class="flex flex-col md:flex-row items-center justify-center gap-3">
          <button id="discover-btn" class="btn-primary w-full md:w-auto">나의 인생 향수 찾기</button>
          <button id="create-btn" class="btn-secondary w-full md:w-auto">나만의 향수 만들기</button>
        </div>
      </div>
    </section>

    <!-- Quiz Screen -->
    <section id="quiz-screen" class="hidden quiz-section">
      <div class="card p-6 md:p-8">
        <div class="mb-6">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-semibold text-accent tracking-wide uppercase">Question <span id="question-number"></span>/18</span>
            <span id="question-type" class="text-xs text-soft tracking-wide uppercase"></span>
          </div>
          <div class="progress-track w-full rounded-full h-2.5">
            <div id="progress-bar" class="progress-bar h-2.5 rounded-full transition-all duration-300"></div>
          </div>
        </div>
        <h2 id="question-title" class="text-2xl md:text-3xl font-bold mb-6 leading-snug"></h2>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
        <div id="button-container" class="mt-6 flex justify-between items-center gap-4">
          <button id="prev-button" class="btn-secondary hidden">이전</button>
          <button id="next-button" class="btn-primary">다음</button>
        </div>
      </div>
    </section>

    <!-- Loading Screen -->
    <section id="loading-screen" class="hidden text-center fade-in">
      <div class="card p-8 flex flex-col items-center justify-center min-h-[400px]">
        <div id="loader" class="loader mb-6"></div>
        <h2 id="loading-title" class="text-2xl font-bold mb-2">AI가 분석 중입니다.</h2>
        <p id="loading-message" class="text-soft leading-relaxed">당신의 감성과 기억에서<br>가장 빛나는 향기를 찾는 중...</p>
        <div id="retry-container" class="hidden mt-6">
          <button id="retry-btn" class="btn-outline">다시 요청</button>
        </div>
      </div>
    </section>

    <!-- Results Screen -->
    <section id="results-screen" class="hidden fade-in">
      <div class="card p-6 md:p-8">
        <div class="text-center mb-6">
          <p id="result-badge" class="badge-gold">당신만의 향기 페르소나</p>
          <h3 id="result-title" class="text-2xl md:text-3xl font-bold"></h3>
          <p id="result-description" class="text-soft mt-2 leading-relaxed"></p>
        </div>
        <div id="notes-container" class="notes-grid hidden"></div>
        <div id="recommendations-container" class="space-y-4"></div>
        <div class="mt-8 text-center">
          <button id="restart-btn" class="btn-secondary">처음으로 돌아가기</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ----- Elements
    const startDiscoverBtn = document.getElementById('discover-btn');
    const startCreateBtn = document.getElementById('create-btn');
    const retryBtn = document.getElementById('retry-btn');
    const restartBtn = document.getElementById('restart-btn');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const loadingScreen = document.getElementById('loading-screen');
    const resultsScreen = document.getElementById('results-screen');
    const questionNumberEl = document.getElementById('question-number');
    const questionTotalEl = document.getElementById('question-total');
    const questionTypeEl = document.getElementById('question-type');
    const progressBarEl = document.getElementById('progress-bar');
    const questionTitleEl = document.getElementById('question-title');
    const optionsContainer = document.getElementById('options-container');
    const nextButton = document.getElementById('next-button');
    const loader = document.getElementById('loader');
    const retryContainer = document.getElementById('retry-container');
    const loadingTitle = document.getElementById('loading-title');
    const loadingMessage = document.getElementById('loading-message');
    const resultBadge = document.getElementById('result-badge');
    const resultTitle = document.getElementById('result-title');
    const resultDescription = document.getElementById('result-description');
    const notesContainer = document.getElementById('notes-container');
    const recommendationsContainer = document.getElementById('recommendations-container');

    startDiscoverBtn.addEventListener('click', () => startQuiz('discover'));
    startCreateBtn.addEventListener('click', () => startQuiz('create'));
    nextButton.addEventListener('click', nextQuestion);
    retryBtn.addEventListener('click', showLoadingAndAnalyze);
    restartBtn.addEventListener('click', restartQuiz);

    // ----- Quiz Data
    const discoverQuizData = [
      { question: '어떤 타입의 향수를 찾고 계신가요?', type: 'single', options: ['남성향수', '여성향수', '젠더뉴트럴 향수', '상관없음 (모든 타입)'] },
      { question: '이 향수를 주로 언제, 어디서 사용하고 싶으신가요?', type: 'single', options: ['매일 편안하게 (데일리)', '중요한 미팅·발표 (프로페셔널)', '설레는 데이트·소개팅 (로맨틱)', '친구들과의 즐거운 모임 (소셜)', '혼자만의 휴식 시간 (릴랙스)'] },
      { question: '어떤 향 계열에 마음이 끌리시나요?', type: 'multiple', options: ['다채로운 꽃의 향연(플로럴)', '달콤 생기 있는 과즙(프루티)', '상큼 청량한 시트러스', '차분한 숲과 나무(우디)', '따뜻하고 이국적인 느낌(스파이시·오리엔탈)', '포근한 비누·살결 느낌(머스크·파우더리)'] },
      { question: '향수를 통해 표현하고 싶은 이미지는?', type: 'multiple', options: ['세련되고 도시적인', '따뜻하고 부드러운', '관능적이고 매혹적인', '지적이고 신뢰감 있는', '순수하고 깨끗한', '개성 있고 유니크한'] },
      { question: '평소 즐겨 입는 패션 스타일은?', type: 'multiple', options: ['미니멀·클래식', '캐주얼·스포티', '모던·시크', '페미닌·로맨틱', '유니크·빈티지'] },
      { question: '가장 좋아하는 하루의 시간대는 언제인가요?', type: 'single', options: ['이슬 맺힌 고요한 새벽', '햇살 쏟아지는 나른한 오후', '붉은 노을의 해질녘', '별이 빛나는 차분한 밤'] },
      { question: '마음이 편안해지는 장소를 고르세요.', type: 'multiple', options: ['비 온 뒤의 촉촉한 숲속', '파도 소리가 들리는 한적한 해변', '오래된 책 냄새가 나는 서재', '향기로운 꽃이 가득한 정원', '갓 구운 빵 냄새가 나는 골목'] },
      { question: '선호하는 원단의 감촉은 어떤가요?', type: 'single', options: ['부드럽게 감싸는 캐시미어', '시원하고 쾌적한 린넨', '매끄럽게 흐르는 실크', '깨끗하고 빳빳한 코튼'] },
      { question: '촉감으로 비유하면 어떤 쪽이 더 끌리나요?', type: 'single', options: ['보송한 파우더', '맑고 투명한 물기', '부드럽고 크리미함', '건조한 나무결', '서늘한 유리감'] },
      { question: '향의 존재감은 어느 정도가 좋나요?', type: 'single', options: ['내게만 은은하게', '대화 거리에서 느껴짐', '스치면 분명히 전해짐', '공간을 채우는 편'] },
      { question: '원하는 잔향 길이는?', type: 'single', options: ['2–4시간', '6–8시간', '10시간 이상', '의류에도 오래 남아도 좋음'] },
      { question: '향에 대한 민감도는?', type: 'single', options: ['쉽게 두통·피로를 느낌', '가끔 민감', '거의 괜찮음'] },
      { question: '향수를 선택할 때 더 중요한 것은?', type: 'single', options: ['많은 사람이 좋아하는 '베스트셀러'', '나만 알고 싶은 '니치 향수''] },
      { question: '피하고 싶은 향의 느낌이 있다면?', type: 'single', options: ['너무 달아 울렁거림', '인공적으로 머리 아픔', '톡 쏘듯 자극적임', '스모키·가죽 느낌', '특별히 없음'] },
      { question: '기피하는 향 노트를 모두 고르세요.', type: 'multiple', options: ['지나치게 달달한 디저트 느낌', '진한 흰꽃의 화사함', '분말가루 같은 파우더감', '축축한 흙·이끼 느낌', '가죽·훈연·타는 나무 느낌', '바닷물·세제 같은 느낌', '시나몬·정향 같은 강한 향신 느낌', '약품·멘톨 같은 의약품 느낌', '과일 캔디처럼 인공 과즙 느낌', '레몬 세제 같은 청소세제 느낌', '특별히 없음'] },
      { question: '당신의 인생 향을 떠오르는 장면이나 단어로 자유롭게 적어주세요.', type: 'text', placeholder: '예: 비 갠 뒤 골목, 막 다린 셔츠, 차가운 유리창, 오후의 햇살' }
    ];

    const createQuizData = [
      { question: '향수를 뿌렸을 때, 가장 먼저 어떤 느낌으로 시작하고 싶으신가요?', type: 'single', options: ['상쾌한 바람처럼', '톡 쏘는 과일처럼', '은은한 꽃잎처럼', '깨끗한 비누처럼'] },
      { question: '당신의 마음을 가장 편안하게 해주는 장소는 어디인가요?', type: 'single', options: ['고요한 새벽의 숲', '햇살 가득한 과수원', '오래된 책들이 가득한 서재', '부드러운 모래사장의 해변'] },
      { question: '향수가 시간이 지남에 따라 어떤 분위기를 자아냈으면 하나요?', type: 'single', options: ['따뜻하고 포근한', '우아하고 세련된', '신비롭고 매혹적인', '활기차고 긍정적인'] },
      { question: '향기를 질감으로 표현한다면 어떤 느낌에 가까운가요?', type: 'single', options: ['부드러운 벨벳', '가볍고 투명한 쉬폰', '묵직하고 따뜻한 울', '바삭바삭한 마른 잎사귀'] },
      { question: '향기에 달콤함을 더한다면, 어떤 종류의 달콤함이 좋을까요?', type: 'single', options: ['잘 익은 과일의 달콤함', '부드러운 바닐라 아이스크림', '향긋한 꿀 한 스푼', '달콤함은 별로 원하지 않아요'] },
      { question: '당신의 향수에 약간의 스파이스를 더해 개성을 표현한다면?', type: 'single', options: ['따뜻한 시나몬', '톡 쏘는 생강', '이국적인 향신료', '스파이시함은 원하지 않아요'] },
      { question: '마지막으로 피부에 남는 잔향은 어떤 느낌이었으면 좋겠나요?', type: 'single', options: ['차분하고 안정적인 나무 향', '부드럽고 관능적인 머스크 향', '흙과 이끼의 자연스러운 향', '깨끗하고 맑은 느낌'] },
      { question: '이 향수가 가장 어울릴 것 같은 시간대는 언제인가요?', type: 'single', options: ['상쾌한 아침', '나른한 오후', '로맨틱한 저녁', '깊고 조용한 밤'] },
      { question: '당신이 만들 향수를 색으로 표현한다면 어떤 색상 계열일까요?', type: 'single', options: ['따뜻한 베이지·브라운 계열', '부드러운 파스텔 톤', '깊고 짙은 버건디·네이비 계열', '맑고 투명한 느낌의 색'] },
      { question: '당신의 향수에 붙여주고 싶은 이름이나, 떠오르는 단어가 있다면 자유롭게 적어주세요.', type: 'text', placeholder: '예: 새벽의 안개, 별의 속삭임, 나의 첫 여름...' }
    ];

    // ----- State
    let currentMode = null;
    let currentQuizData = discoverQuizData;
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let selectedOptions = new Set();
    let isProcessing = false;

    function startQuiz(mode) {
      currentMode = mode;
      currentQuizData = mode === 'create' ? createQuizData : discoverQuizData;
      currentQuestionIndex = 0;
      userAnswers = [];
      selectedOptions.clear();
      isProcessing = false;
      questionNumberEl.textContent = 1;
      questionTotalEl.textContent = currentQuizData.length;
      questionTypeEl.textContent = '';
      progressBarEl.style.width = `${(1 / currentQuizData.length) * 100}%`;

      startScreen.classList.add('hidden');
      quizScreen.classList.remove('hidden');
      displayQuestion();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function displayQuestion() {
      selectedOptions.clear();
      const question = currentQuizData[currentQuestionIndex];
      const isLast = currentQuestionIndex === currentQuizData.length - 1;
      questionNumberEl.textContent = currentQuestionIndex + 1;
      progressBarEl.style.width = `${((currentQuestionIndex + 1) / currentQuizData.length) * 100}%`;
      questionTitleEl.textContent = question.question;
      optionsContainer.innerHTML = '';
      nextButton.textContent = isLast ? '결과 보기' : '다음';

      if (question.type === 'text') {
        questionTypeEl.textContent = '주관식 (자유 입력)';
        document.getElementById('next-button-container').classList.remove('hidden');
        optionsContainer.classList.remove('md:grid-cols-2');
        const textArea = document.createElement('textarea');
        textArea.id = 'text-answer';
        textArea.className = 'w-full h-32 p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-[rgba(201,169,106,0.45)] focus:border-[rgba(201,169,106,0.8)] transition';
        textArea.placeholder = question.placeholder || '';
        optionsContainer.appendChild(textArea);
        nextButton.disabled = false;
      } else {
        questionTypeEl.textContent = question.type === 'multiple' ? '복수 선택 가능' : '단일 선택';
        document.getElementById('next-button-container').classList.toggle('hidden', question.type === 'single');
        optionsContainer.classList.add('md:grid-cols-2');
        question.options.forEach((optionText, index) => {
          const card = document.createElement('div');
          card.className = 'option-card text-left';
          card.textContent = optionText;
          card.dataset.optionIndex = index;
          card.addEventListener('click', () => toggleOption(card, question.type));
          optionsContainer.appendChild(card);
        });
        updateNextButtonState();
      }
    }

    function toggleOption(card, type) {
      if (isProcessing) return;
      const optionIndex = card.dataset.optionIndex;

      if (type === 'single') {
        isProcessing = true;
        if (selectedOptions.has(optionIndex)) return;
        const currentSelected = optionsContainer.querySelector('.selected');
        if (currentSelected) currentSelected.classList.remove('selected');
        card.classList.add('selected');
        selectedOptions.clear();
        selectedOptions.add(optionIndex);
        setTimeout(() => {
          nextQuestion();
          isProcessing = false;
        }, 250);
      } else {
        if (selectedOptions.has(optionIndex)) {
          selectedOptions.delete(optionIndex);
          card.classList.remove('selected');
        } else {
          selectedOptions.add(optionIndex);
          card.classList.add('selected');
        }
        updateNextButtonState();
      }
    }

    function updateNextButtonState() {
      const question = currentQuizData[currentQuestionIndex];
      if (question.type === 'multiple') {
        nextButton.disabled = selectedOptions.size === 0;
      } else {
        nextButton.disabled = false;
      }
    }

    function collectCurrentAnswer(question) {
      if (question.type === 'text') {
        const textAnswer = (document.getElementById('text-answer')?.value || '').trim();
        userAnswers.push({ question: question.question, answers: [textAnswer] });
      } else {
        const selectedTexts = Array.from(selectedOptions).map(index => question.options[parseInt(index, 10)]);
        if (selectedTexts.length > 0) {
          userAnswers.push({ question: question.question, answers: selectedTexts });
        } else if (question.type === 'multiple') {
          userAnswers.push({ question: question.question, answers: [] });
        }
      }
    }

    function nextQuestion() {
      const question = currentQuizData[currentQuestionIndex];
      collectCurrentAnswer(question);
      currentQuestionIndex++;
      if (currentQuestionIndex < currentQuizData.length) {
        displayQuestion();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else {
        showLoadingAndAnalyze();
      }
    }

    async function showLoadingAndAnalyze() {
      quizScreen.classList.add('hidden');
      loadingScreen.classList.remove('hidden');
      loader.classList.remove('hidden');
      retryContainer.classList.add('hidden');
      loadingTitle.textContent = 'AI가 분석 중입니다.';
      loadingMessage.innerHTML = currentMode === 'create'
        ? '당신만의 향 조합을 분석해<br>새로운 조향 결과를 만드는 중...'
        : '당신의 감성과 기억에서<br>가장 빛나는 향기를 찾는 중...';
      try {
        const result = await callGeminiAPI(userAnswers, currentMode);
        displayResults(result);
      } catch (error) {
        console.error('AI analysis error:', error);
        loader.classList.add('hidden');
        loadingTitle.textContent = '오류 발생';
        loadingMessage.innerHTML = '죄송합니다. 분석 중 오류가 발생했습니다.<br>다시 한 번 시도해주세요.';
        retryContainer.classList.remove('hidden');
      }
    }

    async function callGeminiAPI(answers, mode) {
      const response = await fetch('/api/gemini', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ answers, mode })
      });
      if (!response.ok) {
        const text = await response.text().catch(() => '');
        throw new Error(`API request failed: ${response.status} ${text}`);
      }
      return response.json();
    }

    function renderRecommendations(list) {
      recommendationsContainer.innerHTML = '';
      (list || []).forEach((perfume, index) => {
        const encodedName = encodeURIComponent((perfume.name || '').replace(/\s+/g, '+'));
        const keywords = Array.isArray(perfume.keywords) ? perfume.keywords : [];
        const card = `
          <div class="recommendation-card fade-in" style="animation-delay: ${index * 0.2}s;">
            <div class="flex items-start sm:items-center gap-4">
              <img src="https://placehold.co/100x100/EFE6D8/53483F?text=${encodedName}" alt="${perfume.name || ''}" class="w-20 h-20 md:w-24 md:h-24 rounded-2xl object-cover flex-shrink-0" style="border: 1px solid rgba(83, 72, 63, 0.12); background-color: rgba(255, 255, 255, 0.75);">
              <div class="flex-grow">
                <div class="flex justify-between items-start gap-3">
                  <div>
                    <p class="text-sm text-accent font-semibold">${perfume.brand || ''}</p>
                    <h4 class="text-lg md:text-xl font-bold">${perfume.name || ''}</h4>
                  </div>
                  <span class="tag">추천 ${index + 1}</span>
                </div>
                <p class="text-soft mt-2 mb-3 leading-relaxed">${perfume.description || ''}</p>
                ${keywords.length ? `<div class="flex flex-wrap gap-2">${keywords.map(kw => `<span class="keyword-chip">${kw}</span>`).join('')}</div>` : ''}
              </div>
            </div>
            <div class="mt-5 pt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4" style="border-top: 1px solid rgba(83, 72, 63, 0.12);">
              <div>
                <p class="subtle-text">예상 가격</p>
                <p class="font-semibold price-text">${perfume.price || '가격 정보 없음'}</p>
              </div>
              <a href="${perfume.purchaseLink || '#'}" target="_blank" rel="noopener" class="btn-outline">구매 링크</a>
            </div>
          </div>`;
        recommendationsContainer.innerHTML += card;
      });
    }

    function renderNotes(notes) {
      notesContainer.innerHTML = '';
      if (!notes || typeof notes !== 'object') {
        notesContainer.classList.add('hidden');\n        notesContainer.innerHTML = '';
        return;
      }
      const noteOrder = [
        { key: 'top', label: 'Top Notes' },
        { key: 'middle', label: 'Middle Notes' },
        { key: 'base', label: 'Base Notes' }
      ];
      const fragments = noteOrder
        .map(({ key, label }) => {
          const value = notes[key];
          if (!value) return '';
          const display = Array.isArray(value) ? value.join(', ') : value;
          if (!display) return '';
          return `<div class="note-card"><h4>${label}</h4><p>${display}</p></div>`;
        })
        .filter(Boolean);
      if (!fragments.length) {
        notesContainer.classList.add('hidden');\n        notesContainer.innerHTML = '';
        return;
      }
      notesContainer.innerHTML = fragments.join('
');
      notesContainer.classList.remove('hidden');
    }

    function displayResults(result) {
      loadingScreen.classList.add('hidden');
      resultsScreen.classList.remove('hidden');

      if (currentMode === 'create') {
        const perfume = result?.perfume || {};
        resultBadge.textContent = '나만의 향수 조향 결과';
        resultTitle.textContent = perfume.name || '당신만의 향수';
        resultDescription.textContent = perfume.description || '사용자 취향을 토대로 조향한 향수입니다.';
        renderNotes(perfume.notes);
        renderRecommendations(result?.recommendations || []);
      } else {
        const persona = result?.persona || {};
        resultBadge.textContent = '당신만의 향기 페르소나';
        resultTitle.textContent = persona.title || '향기 페르소나';
        resultDescription.textContent = persona.description || '당신의 취향을 토대로 분석한 향기 페르소나입니다.';
        notesContainer.classList.add('hidden');\n        notesContainer.innerHTML = '';
        recommendationsContainer.innerHTML = '';
        renderRecommendations(result?.recommendations || []);
      }
    }

    function restartQuiz() {
      currentMode = null;
      currentQuizData = discoverQuizData;
      startScreen.classList.remove('hidden');
      quizScreen.classList.add('hidden');
      loadingScreen.classList.add('hidden');
      resultsScreen.classList.add('hidden');
      startScreen.classList.add('fade-in');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>
</body>
</html>






