<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scent Finder: AI가 찾아주는 당신의 인생 향수</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .font-serif {
            font-family: 'Playfair Display', serif;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        .option-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .option-card.selected {
            border-color: #4f46e5;
            background-color: #eef2ff;
            transform: translateY(-2px);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-2xl mx-auto p-4 md:p-8">

        <!-- Start Screen -->
        <section id="start-screen" class="text-center fade-in">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h1 class="text-4xl md:text-5xl font-serif font-bold text-gray-900 mb-4">Scent Finder</h1>
                <p class="text-lg text-gray-600 mb-6">
                    당신의 기억과 감성 속에 숨겨진<br>인생 향수를 찾아드릴게요.
                </p>
                <p class="text-gray-500 mb-8">Gemini AI가 15가지 질문으로 당신의 취향을 분석합니다.</p>
                <button onclick="startQuiz()" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full hover:bg-indigo-700 transition-colors shadow-md text-lg">
                    내 향수 찾기 시작
                </button>
            </div>
        </section>

        <!-- Quiz Screen -->
        <section id="quiz-screen" class="hidden">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-indigo-600">Question <span id="question-number"></span>/15</span>
                        <span id="question-type" class="text-xs text-gray-500"></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300"></div>
                    </div>
                </div>
                <h2 id="question-title" class="text-2xl font-bold mb-6 text-gray-900 leading-snug"></h2>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Options/Input will be dynamically added here -->
                </div>
                <div id="next-button-container" class="mt-8 text-center">
                    <button id="next-button" onclick="nextQuestion()" class="bg-indigo-600 text-white font-bold py-3 px-12 rounded-full hover:bg-indigo-700 transition-colors shadow-md disabled:bg-gray-300">
                        다음
                    </button>
                </div>
            </div>
        </section>

        <!-- Loading Screen -->
        <section id="loading-screen" class="hidden text-center fade-in">
             <div class="bg-white p-8 rounded-2xl shadow-lg flex flex-col items-center justify-center min-h-[400px]">
                <div id="loader" class="loader mb-6"></div>
                <h2 id="loading-title" class="text-2xl font-bold text-gray-900 mb-2">Gemini AI가 분석 중입니다.</h2>
                <p id="loading-message" class="text-gray-600">당신의 감성과 기억 속에서<br>가장 빛나는 향기를 찾는 중...</p>
                <div id="retry-container" class="hidden mt-6">
                    <button onclick="showLoadingAndAnalyze()" class="bg-red-600 text-white font-bold py-3 px-8 rounded-full hover:bg-red-700 transition-colors">
                        다시 요청
                    </button>
                </div>
            </div>
        </section>

        <!-- Results Screen -->
        <section id="results-screen" class="hidden">
             <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg text-center fade-in">
                <h2 class="text-xl font-serif text-indigo-600 mb-2">당신의 향기 페르소나</h2>
                <p id="persona-title" class="text-3xl font-bold text-gray-900 mb-4"></p>
                <p id="persona-description" class="text-gray-600 mb-8 max-w-lg mx-auto"></p>

                <div class="border-t border-gray-200 pt-8">
                    <h3 class="text-2xl font-bold text-gray-900 mb-6">당신을 위한 맞춤 향수</h3>
                    <div id="recommendations-container" class="space-y-6">
                        <!-- Recommended perfumes will be dynamically added here -->
                    </div>
                </div>
                
                <div class="mt-10">
                    <button onclick="restartQuiz()" class="bg-gray-200 text-gray-800 font-bold py-3 px-8 rounded-full hover:bg-gray-300 transition-colors">
                        테스트 다시하기
                    </button>
                </div>
            </div>
        </section>

    </div>

    <script>
        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const loader = document.getElementById('loader');
        const loadingTitle = document.getElementById('loading-title');
        const loadingMessage = document.getElementById('loading-message');
        const retryContainer = document.getElementById('retry-container');
        const resultsScreen = document.getElementById('results-screen');
        const questionNumberEl = document.getElementById('question-number');
        const questionTypeEl = document.getElementById('question-type');
        const progressBarEl = document.getElementById('progress-bar');
        const questionTitleEl = document.getElementById('question-title');
        const optionsContainer = document.getElementById('options-container');
        const nextButtonContainer = document.getElementById('next-button-container');
        const nextButton = document.getElementById('next-button');

        // --- Quiz Data ---
        const quizData = [
            { question: "이 향수를 주로 언제, 어디서 사용하고 싶으신가요?", type: 'multiple', options: ["매일 아침, 출근길 (데일리)", "주말 브런치/카페 (캐주얼)", "중요한 미팅 (프로페셔널)", "설레는 데이트 (로맨틱)", "친구들과의 저녁 모임 (소셜)", "잠들기 전, 나만의 시간 (릴랙스)"] },
            { question: "어떤 향 계열에 마음이 끌리시나요?", type: 'multiple', options: ["다채로운 꽃의 향연 (플로럴)", "달콤 생기있는 과즙 (프루티)", "상큼 청량한 시트러스", "차분한 숲과 나무 (우디)", "따뜻하고 이국적인 (스파이시/오리엔탈)", "포근한 비누/살결 (머스크/파우더리)"] },
            { question: "향기의 존재감은 어느 정도가 좋으신가요?", type: 'single', options: ["스치듯 은은하게, 나만 아는 정도", "가까이 다가오면 느껴질 정도", "확실한 존재감으로 공간을 채울 정도"] },
            { question: "향수를 통해 표현하고 싶은 이미지는?", type: 'multiple', options: ["세련되고 도시적인", "따뜻하고 부드러운", "관능적이고 매혹적인", "지적이고 신뢰감 있는", "순수하고 깨끗한", "개성 있고 유니크한"] },
            { question: "가장 좋아하는 하루의 시간대는 언제인가요?", type: 'single', options: ["이슬 맺힌 고요한 새벽", "햇살 쏟아지는 나른한 오후", "붉은 노을이 지는 해질녘", "별이 빛나는 차분한 밤"] },
            { question: "마음이 편안해지는 장소를 골라보세요.", type: 'multiple', options: ["비 온 뒤의 촉촉한 숲속", "파도 소리가 들리는 한적한 해변", "오래된 책 냄새가 나는 서재", "향기로운 꽃으로 가득 찬 정원"] },
            { question: "선호하는 원단의 감촉은 어떤가요?", type: 'single', options: ["부드럽게 감싸는 캐시미어", "시원하고 쾌적한 린넨", "매끄럽게 흐르는 실크", "깨끗하고 빳빳한 코튼"] },
            { question: "즐겨 마시는 음료는 무엇인가요?", type: 'multiple', options: ["쌉쌀한 아메리카노/홍차", "상큼한 과일 주스", "부드러운 라떼", "안정되는 허브티"] },
            { question: "어떤 예술 작품에서 영감을 얻나요?", type: 'single', options: ["모네의 그림 같은 인상주의 회화", "간결한 미니멀리즘 건축", "화려한 바로크 시대의 조각", "서정적인 클래식 음악"] },
            { question: "상상 속 당신의 향기를 색으로 표현한다면?", type: 'multiple', options: ["깨끗한 화이트, 따뜻한 베이지", "사랑스러운 핑크, 부드러운 코랄", "차분한 그린, 깊은 블루", "신비로운 퍼플, 우아한 버건디"] },
            { question: "당신이 평소 즐겨 입는 패션 스타일은?", type: 'multiple', options: ["기본템 위주의 미니멀리즘", "편안하고 활동적인 캐주얼", "여성스러운 라인의 페미닌", "개성 있는 디자인의 유니크/빈티지"] },
            { question: "혹시 기피하는 향이 있다면?", type: 'single', options: ["속이 울렁이는 지나치게 단 향", "머리 아픈 너무 인공적인 향", "너무 강하고 톡 쏘는 향", "특별히 없음"] },
            { question: "향수의 지속력은 어느 정도가 중요한가요?", type: 'single', options: ["매우 중요해요 (6시간 이상)", "어느 정도 중요해요 (3-5시간)", "크게 상관없어요"] },
            { question: "향수를 선택할 때 더 중요한 것은?", type: 'single', options: ["많은 사람이 좋아하는 '베스트셀러'", "나만 알고 싶은 '니치 향수'"] },
            { question: "마지막으로, 당신이 찾고 있는 향기에 대한 느낌이나 단어가 있다면 자유롭게 알려주세요. (선택사항)", type: 'text', placeholder: "예: 비 온 뒤의 흙냄새, 따뜻한 살냄새, 이제 막 세탁한 셔츠의 향기..." }
        ];

        // --- State Management ---
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let selectedOptions = new Set();
        let isProcessing = false; // Prevent multiple clicks during auto-next

        // --- Functions ---

        function startQuiz() {
            startScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            currentQuestionIndex = 0;
            userAnswers = [];
            isProcessing = false;
            displayQuestion();
        }

        function displayQuestion() {
            selectedOptions.clear();
            const question = quizData[currentQuestionIndex];
            const isLastQuestion = currentQuestionIndex === quizData.length - 1;

            questionNumberEl.textContent = currentQuestionIndex + 1;
            progressBarEl.style.width = `${((currentQuestionIndex + 1) / quizData.length) * 100}%`;
            questionTitleEl.textContent = question.question;
            optionsContainer.innerHTML = '';
            
            nextButton.textContent = isLastQuestion ? '결과 보기' : '다음';

            if (question.type === 'text') {
                questionTypeEl.textContent = '주관식 답변 (선택)';
                nextButtonContainer.classList.remove('hidden');
                const textArea = document.createElement('textarea');
                textArea.id = 'text-answer';
                textArea.className = "w-full h-32 p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition";
                textArea.placeholder = question.placeholder;
                optionsContainer.appendChild(textArea);
                optionsContainer.classList.remove('md:grid-cols-2');
                nextButton.disabled = false; // Always enabled for optional question
            } else {
                questionTypeEl.textContent = question.type === 'multiple' ? '중복 선택 가능' : '하나만 선택';
                nextButtonContainer.classList.toggle('hidden', question.type === 'single');
                optionsContainer.classList.add('md:grid-cols-2');
                question.options.forEach((optionText, index) => {
                    const card = document.createElement('div');
                    card.className = "option-card border-2 border-gray-200 p-4 rounded-xl cursor-pointer text-center";
                    card.textContent = optionText;
                    card.dataset.optionIndex = index;
                    card.onclick = () => toggleOption(card, question.type);
                    optionsContainer.appendChild(card);
                });
                updateNextButtonState();
            }
        }

        function toggleOption(card, type) {
            if (isProcessing) return;
            const optionIndex = card.dataset.optionIndex;

            if (type === 'single') {
                isProcessing = true; // Block clicks
                if (selectedOptions.has(optionIndex)) return;
                
                const currentSelected = optionsContainer.querySelector('.selected');
                if (currentSelected) currentSelected.classList.remove('selected');
                
                card.classList.add('selected');
                selectedOptions.clear();
                selectedOptions.add(optionIndex);
                
                setTimeout(() => {
                    nextQuestion();
                    isProcessing = false; // Unblock clicks after transition
                }, 300);

            } else { // multiple
                if (selectedOptions.has(optionIndex)) {
                    selectedOptions.delete(optionIndex);
                    card.classList.remove('selected');
                } else {
                    selectedOptions.add(optionIndex);
                    card.classList.add('selected');
                }
            }
            updateNextButtonState();
        }

        function updateNextButtonState() {
            const question = quizData[currentQuestionIndex];
            if (question.type === 'multiple') {
                nextButton.disabled = selectedOptions.size === 0;
            }
        }

        function nextQuestion() {
            const question = quizData[currentQuestionIndex];
            if (question.type === 'text') {
                const textAnswer = document.getElementById('text-answer').value.trim();
                userAnswers.push({ question: question.question, answers: [textAnswer] });
            } else {
                const selectedTexts = Array.from(selectedOptions).map(index => question.options[parseInt(index)]);
                if (selectedTexts.length > 0) {
                     userAnswers.push({ question: question.question, answers: selectedTexts });
                }
            }

            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) {
                displayQuestion();
            } else {
                showLoadingAndAnalyze();
            }
        }
        
        async function showLoadingAndAnalyze() {
            quizScreen.classList.add('hidden');
            loadingScreen.classList.remove('hidden');

            // Reset loading screen state
            loader.classList.remove('hidden');
            retryContainer.classList.add('hidden');
            loadingTitle.textContent = "Gemini AI가 분석 중입니다.";
            loadingMessage.innerHTML = "당신의 감성과 기억 속에서<br>가장 빛나는 향기를 찾는 중...";
            
            try {
                const result = await callGeminiAPI(userAnswers);
                displayResults(result);
            } catch (error) {
                console.error("AI analysis error:", error);
                loader.classList.add('hidden');
                loadingTitle.textContent = "오류 발생";
                loadingMessage.innerHTML = "죄송합니다, 분석 중 오류가 발생했습니다.<br>잠시 후 다시 시도해주세요.";
                retryContainer.classList.remove('hidden');
            }
        }

        async function callGeminiAPI(answers) {
            // IMPORTANT: The API key is left empty here.
            // The execution environment (Canvas) will automatically provide it.
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let promptText = `
            당신은 세계 최고의 향수 소믈리에입니다. 사용자의 다음 취향 분석 결과를 바탕으로, 사용자를 위한 독창적인 '향기 페르소나'를 정의하고, 시중에서 실제로 판매되는 향수 3가지를 추천해주세요. 
            답변은 반드시 아래의 JSON 형식에 맞춰 한국어로 생성해야 합니다. 
            - 각 향수에 대한 설명은 사용자의 취향과 어떻게 연결되는지 구체적으로 서술해주세요.
            - 'price'에는 대표 용량과 함께 예상 가격대를 "00만원대 / 00ml" 형식으로 기입해주세요.
            - 'purchaseLink'에는 "https://search.shopping.naver.com/search/all?query=브랜드+향수이름" 형식의 검색 URL을 생성해주세요.
            
            사용자 답변:
            `;
            
            answers.forEach(item => {
                // Only include answers that are not empty (especially for the optional text input)
                if(item.answers.length > 0 && item.answers[0].trim() !== '') {
                    promptText += `- ${item.question}: ${item.answers.join(', ')}\n`;
                }
            });

            promptText += `
            \nJSON 출력 형식:
            {
              "persona": { "title": "페르소나 제목", "description": "페르소나에 대한 상세 설명 (2-3문장)" },
              "recommendations": [
                { "brand": "향수 브랜드", "name": "향수 이름", "description": "사용자 취향과 연결된 추천 이유", "keywords": ["#키워드1", "#키워드2", "#키워드3"], "price": "00만원대 / 00ml", "purchaseLink": "네이버 쇼핑 검색 URL" },
                { "brand": "향수 브랜드", "name": "향수 이름", "description": "사용자 취향과 연결된 추천 이유", "keywords": ["#키워드1", "#키워드2", "#키워드3"], "price": "00만원대 / 00ml", "purchaseLink": "네이버 쇼핑 검색 URL" },
                { "brand": "향수 브랜드", "name": "향수 이름", "description": "사용자 취향과 연결된 추천 이유", "keywords": ["#키워드1", "#키워드2", "#키워드3"], "price": "00만원대 / 00ml", "purchaseLink": "네이버 쇼핑 검색 URL" }
              ]
            }`;

            const payload = { contents: [{ parts: [{ text: promptText }] }] };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            
            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (!candidate || !candidate.content?.parts?.[0]?.text) {
                throw new Error("Invalid response structure from AI.");
            }
            
            const textResponse = candidate.content.parts[0].text;
            const jsonMatch = textResponse.match(/```json\n([\s\S]*?)\n```|({[\s\S]*})/);
            
            if (!jsonMatch) {
                throw new Error("Could not extract valid JSON from AI response.");
            }
            
            try {
                const jsonString = jsonMatch[1] || jsonMatch[2];
                return JSON.parse(jsonString);
            } catch (jsonError) {
                throw new Error("Failed to parse JSON from AI response.");
            }
        }

        function displayResults(result) {
            loadingScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');

            document.getElementById('persona-title').textContent = result.persona.title;
            document.getElementById('persona-description').textContent = result.persona.description;

            const recommendationsContainer = document.getElementById('recommendations-container');
            recommendationsContainer.innerHTML = '';
            result.recommendations.forEach((perfume, index) => {
                const encodedName = encodeURIComponent(perfume.name.replace(/ /g, '+'));
                const card = `
                    <div class="bg-gray-50 p-4 rounded-xl text-left fade-in" style="animation-delay: ${index * 0.2}s;">
                        <div class="flex items-start sm:items-center space-x-4">
                            <img src="https://placehold.co/100x100/F3F4F6/333333?text=${encodedName}" alt="${perfume.name}" class="w-20 h-20 md:w-24 md:h-24 rounded-lg object-cover flex-shrink-0">
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-indigo-600 font-semibold">${perfume.brand}</p>
                                        <h4 class="text-lg md:text-xl font-bold text-gray-900">${perfume.name}</h4>
                                    </div>
                                    <span class="text-xs font-bold bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full whitespace-nowrap ml-2">추천 ${index + 1}</span>
                                </div>
                                <p class="text-sm text-gray-600 mt-1 mb-2">${perfume.description}</p>
                                <div class="flex flex-wrap gap-2">
                                    ${(perfume.keywords || []).map(kw => `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-md">${kw}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                            <div>
                                <p class="text-xs text-gray-500">예상 가격</p>
                                <p class="font-bold text-gray-800">${perfume.price || '가격 정보 없음'}</p>
                            </div>
                            <a href="${perfume.purchaseLink}" target="_blank" class="bg-indigo-500 text-white text-sm font-bold py-2 px-4 rounded-full hover:bg-indigo-600 transition-colors">
                                구매 링크
                            </a>
                        </div>
                    </div>
                `;
                recommendationsContainer.innerHTML += card;
            });
        }
        
        function restartQuiz() {
            resultsScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            startScreen.classList.add('fade-in');
        }
    </script>
</body>
</html>

